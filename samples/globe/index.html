<!DOCTYPE HTML>
<!--
 * Copyright 2010, Google Inc.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-->
<html>
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=Edge;chrome=1" />
<title>WebGL Story Sphere</title>

<link href='http://fonts.googleapis.com/css?family=Nobile:regular,bold' rel='stylesheet' type='text/css'>

<link href="imagesphere/style.css" rel="stylesheet"/>
<link href="imagesphere/button.css" rel="stylesheet"/>


<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
<script type="text/javascript" src="js/webgl-test-utils.js"></script>
<script type="text/javascript" src="js/webgl-debug.js"></script>
<script type="text/javascript" src="tdl/base.js"></script>

<script type="text/javascript">


if (window.parent.Modernizr && window.parent.Modernizr.webgl === false){
  alert('Looks like you don\'t have WebGL Support. Try FF4 or Chrome beta.'); 
}

tdl.require('tdl.buffers');
tdl.require('tdl.fast');
tdl.require('tdl.fps');
tdl.require('tdl.math');
tdl.require('tdl.models');
tdl.require('tdl.primitives');
tdl.require('tdl.programs');
tdl.require('tdl.textures');

// globals
var gl;                   // the gl context.
var wu = WebGLTestUtils;  // some webgl utils
var wd = WebGLDebugUtils; // more webgl utils
var canvas;               // the canvas
var math;                 // the math lib.
var fast;                 // the fast math lib.
var g_fpsTimer;           // object to measure frames per second;
var g_logGLCalls = true;  // whether or not to log webgl calls
var g_debug = false;      // whether or not to debug.
var g_drawOnce = false;   // draw just one frame.
var g_canvas2d;           // A global canvas to create textures
var g_ctx2d;              // A global canvas 2d context to create textures
var g_scrollX = 0;        // the position of the grid
var g_scrollY = 0;        // the position of the grid
var g_moveVelocityX = 0;
var g_moveVelocityY = 0;
var g_viewProjection;
var g_viewProjectionInverse;

// We'll maintain a grid of images this size
// and scroll across them. When one goes off the left it comes on the right.
var g_imagesAcrossGrid = 10;
var g_imagesDownGrid = 10;
var g_textures = [];
var g_lastMousePosition = {x: 0, y: 0};
var g_lastMouseGridPosition = {x: 0, y: 0};

var g_tilesize = 512; // the size of the 2D canvas's.. aka their resolution

//g_drawOnce = true;
//g_debug = true;

var g = {
  globals: {},
  imagePlaneConst:{}};

var g_ui = [
  { obj: 'globals',         name: 'imageScale',         value: 0.304,max:   0.536, min: 0.05 },
  { obj: 'globals',         name: 'imageWidth',         value: 1.0,  max:   5 },
  { obj: 'globals',         name: 'imageHeight',        value: 1.0,  max:   5 },
  { obj: 'globals',         name: 'imageSpacing',       value: 1.03, max:   2.118, min: 1 },
  { obj: 'globals',         name: 'rowOffset',          value: 0.5,  max:   2 },
  { obj: 'globals',         name: 'eyeRadius',          value: 5,    max:  10, min: 3.474 },
  { obj: 'globals',         name: 'selectionIntensity', value: 0,    max:  10 },
  { obj: 'imagePlaneConst', name: 'bendRadius',         value: 2.4,  max:  10 },
  { obj: 'imagePlaneConst', name: 'bendAmount',         value: 0,  max:   1 }];

function ValidateNoneOfTheArgsAreUndefined(functionName, args) {
  for (var ii = 0; ii < args.length; ++ii) {
    if (args[ii] === undefined) {
      console.error("undefined passed to gl." + functionName + "(" +
                wd.glFunctionArgsToString(functionName, args) + ")");
    }
  }
}

function Log(msg) {
  if (g_logGLCalls) {
    wu.log(msg);
  }
}

function LogGLCall(functionName, args) {
  if (g_logGLCalls) {
    ValidateNoneOfTheArgsAreUndefined(functionName, args)
    wu.log("gl." + functionName + "(" +
           wd.glFunctionArgsToString(functionName, args) + ")");
  }
}

function Dump() {
  var lastArgWasNumber = false;
  var numArgs = arguments.length;
  var strs = [];
  for (var ii = 0; ii < numArgs; ++ii) {
    var arg = arguments[ii];
    if (typeof arg == 'number') {
      if (lastArgWasNumber) {
        strs.push(", ");
      }
      strs.push(arg.toFixed(3));
      lastArgWasNumber = true;
    } else {
      strs.push(arg.toString());
      lastArgWasNumber = false;
    }
  }
  wu.log(strs.join(""));
}

function createProgramFromTags(vertexTagId, fragmentTagId) {
  return tdl.programs.loadProgram(
      document.getElementById(vertexTagId).text,
      document.getElementById(fragmentTagId).text);
}

/**
 * Sets up a imagePlane
 */
function setupImagePlane() {
  var textures = {
      diffuseSampler: tdl.textures.loadTexture([128,128,128,255])};
  var program = createProgramFromTags(
      'imageSphereVertexShader',
      'imageSphereFragmentShader');
//  var arrays = tdl.primitives.createCube(1);
  var arrays = tdl.primitives.createPlane(1,1,10,10);
  delete arrays.normal;
  tdl.primitives.reorient(arrays,
      [[1, 0, 0, 0],
       [0, 0, 1, 0],
       [0, -1, 0, 0],
       [0, 0, 0, 1]]);
  return new tdl.models.Model(program, arrays, textures);
}

/**
 * Sets up a blank Plane
 */
function setupBlankPlane() {
  var textures = {};
  var program = createProgramFromTags(
      'blackVertexShader',
      'blackFragmentShader');
  var arrays = tdl.primitives.createPlane(1,1,4,4);
  delete arrays.normal;
  delete arrays.texCoord;
  tdl.primitives.reorient(arrays,
      [[1, 0, 0, 0],
       [0, 0, 1, 0],
       [0, -1, 0, 0],
       [0, 0, 0, 1]]);
  return new tdl.models.Model(program, arrays, textures);
}

// The ImgTexture stuff has to happen inside a function because
// tdl.textures.Texture doesn't exist when this is first executed.
function hack() {

ImgTexture = function() {
  tdl.textures.Texture.call(this, gl.TEXTURE_2D);
  gl.bindTexture(gl.TEXTURE_2D, this.texture);
  gl.texImage2D(
      gl.TEXTURE_2D, 0, gl.RGBA, g_tilesize, g_tilesize, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);
  this.setParameter(gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
  this.setParameter(gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
  this.setParameter(gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_LINEAR);
  this.setParameter(gl.TEXTURE_MAG_FILTER, gl.LINEAR);
}

tdl.base.inherit(ImgTexture, tdl.textures.Texture);

ImgTexture.prototype.load = function(imgUrl, msg) {

  var img = new Image();   
  var that = this;
  this.img = img;
  this.msg = msg;
  img.onload = function() {
    that.uploadTexture();
  }
  img.src = imgUrl;
};

ImgTexture.prototype.uploadTexture = function() {
  var img = this.img;
  var msg = this.msg;
  g_ctx2d.clearRect(0, 0, two2w, two2h);
  // stretch the image to g_tilesize width
  var width = two2w;
  var height = img.height * two2w / img.width;
  // stretch until it's 216 height
  
  var someratio = 0.84375, textpadding = 10;
  
  if (height < (someratio * two2w)) {
    width = img.width * (someratio * two2w) / height;
    height = (someratio * two2w);
  }
  
  // reset shadow
  setShadow(g_ctx2d, "transparent", 0, 0, 0);
  g_ctx2d.drawImage(img, 0, 0, width, height); // throw down the IMG
  
  // base overlay for the headline
  g_ctx2d.fillStyle = "rgba(25,25,25, 0.8)";
  g_ctx2d.fillRect(0, g_tilesize - 94, g_tilesize, g_tilesize); // clear the bottom for text, i think?
  
  // headline
  g_ctx2d.font = "bold 40px Helvetica, Arial, sans-serif";
  g_ctx2d.fillStyle = "rgb(255,255,255)";
  //setShadow(g_ctx2d, "rgba(100,100,100,0.6)", 2, 2, 2);
      // somewhere aroudn 26 char per line
  
  // basic text wrapping
  function fillLine(){
  
    var parts = fillLine.parts || msg.split(' '), line = [];
    
    while ( g_ctx2d.measureText( line.join(' ') ).width < g_tilesize - textpadding * 2) {
        line.push( parts.shift() );
    }
    parts.unshift( line.pop() ); // it always does one extra.
  
    fillLine.parts = parts;
    return line.join(' ');
  }
      
  g_ctx2d.fillText( fillLine(msg), textpadding, g_tilesize - 56);
  g_ctx2d.fillText( fillLine(msg), textpadding, g_tilesize - 36 + 20);
  
  gl.bindTexture(gl.TEXTURE_2D, this.texture);
  gl.texSubImage2D(gl.TEXTURE_2D, 0, 0, 0, gl.RGBA, gl.UNSIGNED_BYTE, g_canvas2d);
  gl.generateMipmap(gl.TEXTURE_2D);
};

ImgTexture.prototype.bindToUnit = function(unit) {
  gl.activeTexture(gl.TEXTURE0 + unit);
  gl.bindTexture(gl.TEXTURE_2D, this.texture);
};

}  // hack.


function setShadow(ctx, color, ox, oy, blur) {
  ctx.shadowColor = color;
  ctx.shadowOffsetX = ox;
  ctx.shadowOffsetY = oy;
  ctx.shadowBlur = blur;
}


/**
 * Returns the absolute position of an element for certain browsers.
 * @param {HTML Element} element The element to get a position for.
 * @return {Object} An object containing x and y as the absolute position
 *     of the given element.
 */
var getAbsolutePosition = function(element) {
  var r = { x: element.offsetLeft, y: element.offsetTop };
  if (element.offsetParent) {
    var tmp = getAbsolutePosition(element.offsetParent);
    r.x += tmp.x;
    r.y += tmp.y;
  }
  return r;
};

 /**
  * Retrieve the coordinates of the given event relative to the center
  * of the widget.
  *
  * @param {eventInfo} eventInfo As returned from
  *     CLIENT3DJS.util.getEventInfo.
  * @param {HTML Element} opt_reference A DOM element whose position we want
  *     to transform the mouse coordinates to. If it is not passed in the
  *     element in the eventInfo will be used.
  * @return {Object} An object containing keys 'x' and 'y'.
  */
var getRelativeCoordinates = function(eventInfo, opt_reference) {
  var x, y;
  var event = eventInfo.event;
  var element = eventInfo.element;
  var reference = opt_reference || eventInfo.element;
  if (!window.opera && typeof event.offsetX != 'undefined') {
    // Use offset coordinates and find common offsetParent
    var pos = { x: event.offsetX, y: event.offsetY };
    // Send the coordinates upwards through the offsetParent chain.
    var e = element;
    while (e) {
      e.mouseX = pos.x;
      e.mouseY = pos.y;
      pos.x += e.offsetLeft;
      pos.y += e.offsetTop;
      e = e.offsetParent;
    }
    // Look for the coordinates starting from the reference element.
    var e = reference;
    var offset = { x: 0, y: 0 }
    while (e) {
      if (typeof e.mouseX != 'undefined') {
        x = e.mouseX - offset.x;
        y = e.mouseY - offset.y;
        break;
      }
      offset.x += e.offsetLeft;
      offset.y += e.offsetTop;
      e = e.offsetParent;
    }
    // Reset stored coordinates
    e = element;
    while (e) {
      e.mouseX = undefined;
      e.mouseY = undefined;
      e = e.offsetParent;
    }
  } else {
    // Use absolute coordinates
    var pos = getAbsolutePosition(reference);
    x = event.pageX - pos.x;
    y = event.pageY - pos.y;
  }
  // Subtract distance to middle
  return { x: x, y: y };
};

var getEventInfo = function(event) {
  event = event ? event : window.event;
  var element = event.target ? event.target : event.srcElement;
  return {
    event: event,
    element: element,
    name: (element.id ? element.id : ('->' + element.toString())),
    wheel: (event.detail ? event.detail : -event.wheelDelta),
    shift: (event.modifiers ? (event.modifiers & Event.SHIFT_MASK) : event.shiftKey)
  };
};

clientPositionToWorldRay = function(
    clientXPosition,
    clientYPosition,
    clientWidth,
    clientHeight) {
  // normScreenX, normScreenY are in frustum coordinates.
  var normScreenX = clientXPosition / (clientWidth * 0.5) - 1;
  var normScreenY = -(clientYPosition / (clientHeight * 0.5) - 1);

  var m = g_viewProjectionInverse;
  var matrix = [
    [m[0], m[1], m[2], m[3]],
    [m[4], m[5], m[6], m[7]],
    [m[8], m[9], m[10], m[11]],
    [m[12], m[13], m[14], m[15]]];

  // Apply inverse view-projection matrix to get the ray in world coordinates.
  return {
      near: math.matrix4.transformPoint(
          matrix, [normScreenX, normScreenY, 0]),
      far: math.matrix4.transformPoint(
          matrix, [normScreenX, normScreenY, 1])
  };
};

var clientPositionToGridPosition = function(
    clientXPosition,
    clientYPosition,
    clientWidth,
    clientHeight) {
  // normScreenX, normScreenY are in frustum coordinates.
  var normScreenX = clientXPosition / (clientWidth * 0.5) - 1;
  var normScreenY = -(clientYPosition / (clientHeight * 0.5) - 1);

  // Compute the sphere's front clip coord.
  var m = g_viewProjection;
  var matrix = [
    [m[0], m[1], m[2], m[3]],
    [m[4], m[5], m[6], m[7]],
    [m[8], m[9], m[10], m[11]],
    [m[12], m[13], m[14], m[15]]];
  var v = [0, 0, g.imagePlaneConst.bendRadius];
  var v = tdl.math.matrix4.transformPoint(
      matrix, v);
  // Apply inverse view-projection matrix to get the ray in world coordinates.
  var m = g_viewProjectionInverse;
  var matrix = [
    [m[0], m[1], m[2], m[3]],
    [m[4], m[5], m[6], m[7]],
    [m[8], m[9], m[10], m[11]],
    [m[12], m[13], m[14], m[15]]];

  var pos = tdl.math.matrix4.transformPoint(
      matrix, [normScreenX, normScreenY, v[2]]);

  // This formula seems wrong :-(
  var unit = computeUnitSize();

  var x = pos[0] / unit.width;
  var y = pos[1] / unit.height;
  return {x: x, y: y};
};

var startX = 0;
var startY = 0;
var scrollXStart = 0;
var scrollYStart = 0;
var down = false;
var numMovesToTrack = 4;
var moveHistory = [];

function addMoveHistory(pos) {
  if (moveHistory.length == numMovesToTrack) {
    moveHistory.shift();
  }
  var now = (new Date()).getTime() * 0.001;
  moveHistory.push({ position: pos, time: now});
}

function getMovePosition(e) {
  var info = getEventInfo(e);
  var m = getRelativeCoordinates(info);
  g_lastMousePosition = m;
  g_lastMouseGridPosition = clientPositionToGridPosition(
     m.x,
     m.y,
     canvas.clientWidth,
     canvas.clientHeight);
  return {x: g_lastMouseGridPosition.x, y: g_lastMouseGridPosition.y};
}

function computeUnitSize() {
  return {
    width: g.globals.imageWidth * g.globals.imageSpacing * g.globals.imageScale,
    height: g.globals.imageHeight * g.globals.imageSpacing * g.globals.imageScale
  };
}

function computeSphereGridInfo() {
  var unit = computeUnitSize();
  var halfCircumfrence = Math.PI;
  var imagesAcrossSphere = Math.floor(halfCircumfrence / unit.width);
  var imagesDownSphere = Math.floor(halfCircumfrence / unit.height);
  var gridXOff = Math.floor(imagesAcrossSphere * -0.5);
  var gridYOff = Math.floor(imagesDownSphere * -0.5);
  var xOff = tdl.math.modClamp(g_scrollX % 1, 1);
  var yOff = tdl.math.modClamp(g_scrollY % 1, 1);
  var texXBase = -tdl.math.modClamp(Math.floor(g_scrollX - gridXOff), g_imagesAcrossGrid);
  var texYBase = -tdl.math.modClamp(Math.floor(g_scrollY - gridYOff), g_imagesDownGrid);

  return {
    unit: unit,
    imagesAcrossSphere: imagesAcrossSphere,
    imagesDownSphere: imagesDownSphere,
    gridXOff: gridXOff,
    gridYOff: gridYOff,
    xOff: xOff,
    yOff: yOff,
    texXBase: texXBase,
    texYBase: texYBase,
  };
}

function computeSelection(si, mousePosition, mouseGridPosition) {
  // figure out which grid point to highlight.
  var ray = clientPositionToWorldRay(
      mousePosition.x,
      mousePosition.y,
      canvas.clientWidth,
      canvas.clientHeight);
  var intersection = raySphereIntersection(
      ray.near, ray.far, [0,0,0], g.imagePlaneConst.bendRadius);
  var sphereSelection = undefined;
  if (intersection) {
    var r = g.imagePlaneConst.bendRadius;
    var x = intersection[0];
    var y = intersection[1];
    var z = intersection[2];
    var longAngle = Math.atan2(x, z);
    var d = Math.sqrt(x * x + z * z);
    var latAngle = Math.atan2(y, d);
    var selectionX = longAngle / si.unit.width;
    var selectionY = latAngle  / si.unit.height;
    sphereSelection = {x: selectionX, y: selectionY};
  }

  var selection = {
    x: mouseGridPosition.x / si.unit.width,
    y: mouseGridPosition.y / si.unit.height,
  };

  if (sphereSelection) {
    selection.x = math.lerpScalar(
          selection.x, sphereSelection.x, g.imagePlaneConst.bendAmount);
    selection.y = math.lerpScalar(
          selection.y, sphereSelection.y, g.imagePlaneConst.bendAmount);
  }

  var sx = -1;
  var sy = -1;
  if (selection) {
    sy = -selection.y + 0.5 - g_scrollY;
    sy = tdl.math.modClamp(Math.floor(sy), g_imagesDownGrid);
    sx = +selection.x + 0.5 - g_scrollX + (sy % 2) * g.globals.rowOffset;
    sx = tdl.math.modClamp(Math.floor(sx), g_imagesAcrossGrid);
  }
  
  return {x: sx, y: sy};
}

function handleMouseDown(e) {
  var pos = getMovePosition(e);
  down = true;
  startX = pos.x;
  startY = pos.y;
  scrollXStart = g_scrollX;
  scrollYStart = g_scrollY;
  g_moveVelocityX = 0;
  g_moveVelocityY = 0;
  moveHistory = [];
  addMoveHistory(pos);
  
  window.lastDown = e;

  var si = computeSphereGridInfo();
  var sel = computeSelection(si, g_lastMousePosition, g_lastMouseGridPosition);
  //var status = document.getElementById("status");
  //status.innerHTML = g_textures[sel.y][sel.x].msg;
  
  window.sel = sel;
  return sel;
}

function handleMouseMove(e) {
  var pos = getMovePosition(e);
  // we are dragging
  if (down) {
    onDrag(e);

    
    addMoveHistory(pos);
    //Dump("sc:", g_scrollX, scrollY);
    g_scrollX = scrollXStart + (pos.x - startX);
    g_scrollY = scrollYStart - (pos.y - startY);
  } else{
    //cursor('')
  }
  return false;
}

function handleMouseUp(e) {
  
  // if we consider this a click...
  if (+e.timeStamp - +lastDown.timeStamp < 150){
    sphereClick(e);
  }
  
  if (down) {
    down = false;
    var pos = getMovePosition(e);
    addMoveHistory(pos);
    // Get the newest and oldest move times. If the are close then spin.
    var oldest = moveHistory[0];
    var newest = moveHistory[moveHistory.length - 1];
    var elapsedTime = newest.time - oldest.time;
    if (elapsedTime < 0.4) {
      g_moveVelocityX =  (newest.position.x - oldest.position.x) / elapsedTime;
      g_moveVelocityY = -(newest.position.y - oldest.position.y) / elapsedTime;
    }
  }
  return false;
}

/**
 * Calculate the intersection of a ray and a sphere
 *
 * point1 + mu1 (point2 - point1)
 * point1 + mu2 (point2 - point1)
 *
 * Return undefined.
 */
function raySphereIntersection(point1, point2, center, radius) {
  var kEpsilon = 0.0001;
  var dp = [
      point2[0] - point1[0],
      point2[1] - point1[1],
      point2[2] - point1[2]];
  var a = dp[0] * dp[0] +
          dp[1] * dp[1] +
          dp[2] * dp[2];
  var b = 2 * (dp[0] * (point1[0] - center[0]) +
               dp[1] * (point1[1] - center[1]) +
               dp[2] * (point1[2] - center[2]));
  var c = center[0] * center[0] +
          center[1] * center[1] +
          center[2] * center[2];
  c += point1[0] * point1[0] +
       point1[1] * point1[1] +
       point1[2] * point1[2];
  c -= 2 * (center[0] * point1[0] +
            center[1] * point1[1] +
            center[2] * point1[2]);
  c -= radius * radius;
  var bb4ac = b * b - 4 * a * c;
  if (Math.abs(a) < kEpsilon || bb4ac < 0) {
    return;
  }

  var sq = Math.sqrt(bb4ac);
  var mu1 = (-b + sq) / (2 * a);
  var mu2 = (-b - sq) / (2 * a);

  var m = Math.min(mu1, mu2);
  return math.addVector(point1, math.mulScalarVector(m, dp));
}

function initialize() {
  math = tdl.math;
  fast = tdl.fast;
  canvas = document.getElementById("canvas");
  g_fpsTimer = new tdl.fps.FPSTimer();
  hack();

  canvas.addEventListener("mousedown", handleMouseDown, false);
  canvas.addEventListener("mousemove", handleMouseMove, false);
  canvas.addEventListener("mouseup", handleMouseUp, false);

  // Create a canvas 2d for making textures with text.
  g_canvas2d = document.createElement('canvas');
  
  
  window.two2w = window.two2h = g_tilesize; 
  
  g_canvas2d.width = two2w;
  g_canvas2d.height = two2h;
  g_ctx2d = g_canvas2d.getContext("2d");

  window.gl = wu.create3DContext(canvas);
  if (g_debug) {
    gl = wd.makeDebugContext(gl, undefined, LogGLCall);
  }
  //gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, gl.TRUE);

  
  var titles = ["Countdown to Mine Rescue: Chile Miners Prepare to Be Lifted Into Sunlight", "The Art of the Deal: How to Haggle for a Used Car", "Special Needs Students Becoming Homecoming Royalty", "Exclusive: After Broken Arm, Boy Cheerleader Still Threatened", "Death for Petit Family Murderer Steven Hayes? Penalty Phase Looms", "Exclusive: 'Catfish's' Angela Wesselman Speaks Out", "'World News' Political Insights -- Outspent Democrats Blast Campaign Rules", "Damage Control: Meg Whitman and the Latino Vote", "House Candidate Rich Iott Defends Nazi Uniform Photos", "Looking for Work? Expect a Lower Salary", "C-4 Explosives Found in Historic New York Cemetery", "Faking It? New Sex Study May Rat You Out", "Here's 'The Situation': Mike Sorrentino Talks About Possibly Leaving 'Jersey Shore'", "Solomon Burke Dies at Amsterdam Airport at 70", "The Conversation: On the Ground in Chile", "Mortgage Bullies?: Banks Accused of Illegally Breaking Into Homes Facing Foreclosure", "100-Year-Old Scotch Pulled From Frozen Crate", "Men Allegedly Scammed by So-Called Military Mistress Speak Out", "No-Holds-Barred Fight: Connecticut Senate Race Tightens", "Sex Offenders Find Safe Haven in 'Miracle Village'",
  
  
  // extras because..... im lazy.
  "Countdown to Mine Rescue: Chile Miners Prepare to Be Lifted Into Sunlight", "The Art of the Deal: How to Haggle for a Used Car", "Special Needs Students Becoming Homecoming Royalty", "Exclusive: After Broken Arm, Boy Cheerleader Still Threatened", "Death for Petit Family Murderer Steven Hayes? Penalty Phase Looms", "Exclusive: 'Catfish's' Angela Wesselman Speaks Out", "'World News' Political Insights -- Outspent Democrats Blast Campaign Rules", "Damage Control: Meg Whitman and the Latino Vote", "House Candidate Rich Iott Defends Nazi Uniform Photos", "Looking for Work? Expect a Lower Salary", "C-4 Explosives Found in Historic New York Cemetery", "Faking It? New Sex Study May Rat You Out", "Here's 'The Situation': Mike Sorrentino Talks About Possibly Leaving 'Jersey Shore'", "Solomon Burke Dies at Amsterdam Airport at 70", "The Conversation: On the Ground in Chile", "Mortgage Bullies?: Banks Accused of Illegally Breaking Into Homes Facing Foreclosure", "100-Year-Old Scotch Pulled From Frozen Crate", "Men Allegedly Scammed by So-Called Military Mistress Speak Out", "No-Holds-Barred Fight: Connecticut Senate Race Tightens", "Sex Offenders Find Safe Haven in 'Miracle Village'",
  
  "Countdown to Mine Rescue: Chile Miners Prepare to Be Lifted Into Sunlight", "The Art of the Deal: How to Haggle for a Used Car", "Special Needs Students Becoming Homecoming Royalty", "Exclusive: After Broken Arm, Boy Cheerleader Still Threatened", "Death for Petit Family Murderer Steven Hayes? Penalty Phase Looms", "Exclusive: 'Catfish's' Angela Wesselman Speaks Out", "'World News' Political Insights -- Outspent Democrats Blast Campaign Rules", "Damage Control: Meg Whitman and the Latino Vote", "House Candidate Rich Iott Defends Nazi Uniform Photos", "Looking for Work? Expect a Lower Salary", "C-4 Explosives Found in Historic New York Cemetery", "Faking It? New Sex Study May Rat You Out", "Here's 'The Situation': Mike Sorrentino Talks About Possibly Leaving 'Jersey Shore'", "Solomon Burke Dies at Amsterdam Airport at 70", "The Conversation: On the Ground in Chile", "Mortgage Bullies?: Banks Accused of Illegally Breaking Into Homes Facing Foreclosure", "100-Year-Old Scotch Pulled From Frozen Crate", "Men Allegedly Scammed by So-Called Military Mistress Speak Out", "No-Holds-Barred Fight: Connecticut Senate Race Tightens", "Sex Offenders Find Safe Haven in 'Miracle Village'",
  
  ];

  var bgcaptions = [
      "A maple tree shows its fall colors on Friday, September 17th, 2010, in Woodstock, Maine. A vast network of county foresters, volunteers and others contribute their observations to state tourism officials, who in turn work up \"foliage forecasts\" published  and elsewhere to let leaf-peepers know where to find the best fall foliage. (AP Photo/Robert F. Bukaty) ",
      "The moon rises into view over the Chugach Mountains in this view from the Anchorage Coastal Wildlife Refuge on Wednesday, September 22, 2010 in Anchorage, Alaska. (AP Photo/Anchorage Daily News, Marc Lester) ",
      "Bunches of Tinta Barroca grapes on the vine at the Quinta dos Malvedos estate, owned by Symington Family Estates, in Vila Real, near Porto, Portugal, on Tuesday, Sept. 21, 2010. (Mario Proenca/Bloomberg) ",
      "Sergey Solovyov, director of Agrostroy farm, inspects wheat in a field, some 450 km (280 mi) south of Barnaul city in the Altai region of Russia on September 22, 2010. Russia, devastated by a severe drought, had harvested 55 million tons of grain by September 22, down 32 percent from a year ago, (REUTERS/Andrei Kasprishin) ",
      "Tree branches covered with changing, multi-colored leaves of fall are seen below a partly cloudy sky in Portland, Oregon on Wednesday, Sept. 22, 2010. (AP Photo/Don Ryan) ",
      "The Space Needle, a passing ferry boat, and a U.S. Coast Guard boat are seen through fog over Elliott Bay, Wednesday, Sept. 15, 2010, in Seattle, Washington. (AP Photo/Ted S. Warren) ",
      "Giant lanterns are displayed as part of Mid-autumn festival celebration at a park in Hong Kong on September 22, 2010. The Mid-Autumn Festival is held on the 15th day of the eighth month in the Chinese calendar; a date that parallels the autumnal equinox of the solar calendar, when the moon is at its fullest. (MIKE CLARKE/AFP/Getty Images) ",
      "A child wearing traditional clothes guides cows during the so-called Desalpe in Charmey near Bulle, Switzerland on September 25, 2010. The Desalpe is the customary annual procession when cows are led back to the plain at the beginning of autumn after grazing during the summer months on mountain pastures. (Reuters/Valentin Flauraud) ",
      "Two cows traditionally decorated for the \"Desalpe\" are pictured in Charmey, Switzerland on September 25, 2010. (Reuters/Valentin Flauraud) ",
      "Pumpkins are presented in the German city of Hassloch on September 12, 2010. The town was hosting a competition to find the best pumpkins  (RONALD WITTEK/AFP/Getty Images) ",
      "Inge Schrimps paddles in a hollowed-out pumpkin across a lake on September 19, 2010 in Ludwigsburg, Germany during the annual Ludwigsburg Pumpkin Festival at Ludwigsburg Castle. (Ralph Orlowski/Getty Images) ",
      "Geese fly just after sunrise Wednesday, Sept. 22, 2010, the last day of summer, in Portland, Oregon. (AP Photo/Rick Bowmer) ",
      "Elliott Cely, 2, of Portland, plays in a pumpkin patch at the Rasmussen Farms Wednesday, Sept. 22, 2010, in Hood River, Oregon. (AP Photo/Rick Bowmer) ",
      "Cattle graze in a meadow on a misty morning - the first day of autumn - in Kirchberg, in the Austrian province of Tyrol on Tuesday, Sept. 21, 2010. (AP Photo/Kerstin Joensson) ",
      "Kashmiri women and men gather rice stalks into bundles in a field on the outskirts of Srinagar on September 26, 2010. In order to harvest Kashmir's 374,000-acre rice crop, the field is drained of water to allow the harvesters access. (SAJJAD HUSSAIN/AFP/Getty Images) ",
      "A seasonal worker tears down hop tendrils from the suspension wires near Aigslbach, Germany, on Thursday, Sept. 9, 2010. The Bavarian region Hallertau, north of Munich is seen as the world's biggest hops-producing area. (AP Photo/Matthias Schrader) ",
      "Autumn leaves behind a Farmstead in Muncy Valley, Sullivan County, Pennsylvania on September 26th, 2010.  here. (  / ) ",
      "Ringmaster Vernon Bergman, reveals the weight of a 20 foot wide, 3,699 pound pumpkin pie on Saturday Sept. 25, 2010 - one that will be the worlds largest once certified by Guinness World Records. The giant pie was baked in New Bremen, Ohio and sponsored by the New Bremen Giant Pumpkin Growers during the town's annual Pumpkinfest. The massive pie took over thirteen hours to bake in a specially made oven. (AP Photo/Sidney Daily News,Luke Gronneberg) ",
      "A Kashmiri nomad carries a sheep on his shoulders in Srinagar on September 25, 2010. The nomads travel with their livestock and trek through the state's rugged mountain terrain to reach pastures where they spend the summer months in the mountains and the winter in the shelter of valleys. (SAJJAD HUSSAIN/AFP/Getty Images) ",
      "A hawk perched on a tree at the edge of Randleman Lake is framed by the harvest moon, near Branson Davis Road in Randolph County, North Carolina, on Wednesday, Sept. 22, 2010. (AP Photo/News & Record, Joseph Rodriguez) ",
      "Pinot Noir grapes for Robert Sinskey Vineyards are picked in the Carneros region of Sonoma, California on Friday, Sept. 24, 2010. Picking for this year's harvest is several weeks later than normal due to an unseasonably cool and mild summer. (AP Photo/Eric Risberg) ",
      "Wine is mixed at the Quinta do Bomfim estate, owned by Symington Family Estates, in Pinhao, near Porto, Portugal, on Wednesday, Sept. 22, 2010. (Mario Proenca/Bloomberg) ",
      "The changing colors and patterns of a leaf are seen in Portland, Oregon on Wednesday, Sept. 22, 2010. (AP Photo/Don Ryan) ",
      "Rain drops fall into a Koi pond at the Japanese Garden, Wednesday, Sept. 15, 2010, in Portland, Oregon. (AP Photo/Rick Bowmer) ",
      "A deer stands among trees and bushes in the mountains in Utah on September 24th, 2010.  here. (  / ) ",
      "A Slovak farmer uses a horse-drawn plow as farmers harvest potatoes using traditional methods while they work on their field in the village of Spisske Podhradie, Slovakia on September 20, 2010. The Spissky Hrad castle is seen in the background. (REUTERS/Petr Josek) ",
      "A team corrals the cranberry harvest in a bog in Hanson, Massachusetts owned by Kravtiz Cranberries. (Boston Globe/Meg Pier) ",
      "Artists wearing Belarusian national dresses hold traditional sheaves as they meet participants at a national festival marking the end of harvest collection in the town of Lida, 150 km (93 mi) west of Minsk, Belarus, Friday, Sept. 24, 2010. (AP Photo/Sergei Grits) ",
      "A visitor to a park in Berlin enjoys some of the last of this year's warm sun at the beginning of autumn on September 23, 2010 in Berlin as temperatures reached 20 degrees Celsius. (JOHANNES EISELE/AFP/Getty Images) ",
      "Brian Chittenden harvests corn at his family's Dutch Hollow Farm in Schodack Landing, New York on Friday, Sept. 24, 2010. (AP Photo/Mike Groll) ",
      "Danny Bolton heads out for a day of fishing on the Lake Worth Pier, Tuesday, Sept. 21, 2010 in Lake Worth, Florida.  (AP Photo/The Palm Beach Post, Lannis Waters) ",
      "Georgian men carry freshly-harvested grapes to a press at a farm near the town of Gurjaani, 110 kms east of the capital Tbilisi, on September 22, 2010. Gurjaani located in the Georgian region of Kakheti is one of the centers of Georgia's wine industry. (VANO SHLAMOV/AFP/Getty Images) ",
      "Storm clouds blow across the sky as the rain starts to fall in a three second exposure made in a pumpkin field in Benton, Pennsylvania on Wednesday afternoon, Sept. 22, 2010, just as a violent storm hit the region. (AP Photo/Bloomsburg Press Enterprise, Jimmy May) ",
      "A man walks on a path as fog rises over the lake at Gray's Lake Park in Des Moines, Iowa on Monday, Sept. 27, 2010. (AP Photo/Charlie Neibergall) ",
      "Fall colors just begin to appear in the trees in the evening light at Water Tank Hollow Vista in Susquehannock State Forest, Potter County, Pennsylvania on September 18th, 2010.  here. (  / ) "

    ];

    var headlines = titles.concat( titles)// bgcaptions);
    
  var images = [
   'imagesphere/assets/videoplay.jpg',
      'imagesphere/assets/bp/a01_25141245.jpg'
    , 'imagesphere/assets/bp/a02_25201595.jpg'
    , 'imagesphere/assets/bp/a03_25192971.jpg'
    , 'imagesphere/assets/bp/a04_25181969.jpg'
    , 'imagesphere/assets/bp/a05_25183903.jpg'
    , 'imagesphere/assets/bp/a06_25084601.jpg'
    , 'imagesphere/assets/bp/a07_25178079.jpg'
    , 'imagesphere/assets/bp/a08_25219649.jpg'
    , 'imagesphere/assets/bp/a09_25220503.jpg'
    , 'imagesphere/assets/bp/a10_25031325.jpg'
    , 'imagesphere/assets/bp/a11_25145135.jpg'
    , 'imagesphere/assets/bp/a12_25184457.jpg'
    , 'imagesphere/assets/bp/a13_25187271.jpg'
    , 'imagesphere/assets/bp/a14_25164423.jpg'
    , 'imagesphere/assets/bp/a15_25233319.jpg'
    , 'imagesphere/assets/bp/a16_90914825.jpg'
    , 'imagesphere/assets/bp/a17_28035645.jpg'
    , 'imagesphere/assets/bp/a18_25228155.jpg'
    , 'imagesphere/assets/bp/a19_25219323.jpg'
    , 'imagesphere/assets/bp/a20_25188557.jpg'
    , 'imagesphere/assets/bp/a21_25208305.jpg'
    , 'imagesphere/assets/bp/a22_25193113.jpg'
    , 'imagesphere/assets/bp/a23_25184585.jpg'
    , 'imagesphere/assets/bp/a24_15061293.jpg'
    , 'imagesphere/assets/bp/a25_21641495.jpg'
    , 'imagesphere/assets/bp/a26_25158197.jpg'
    , 'imagesphere/assets/bp/a27_25069359.jpg'
    , 'imagesphere/assets/bp/a28_25207605.jpg'
    , 'imagesphere/assets/bp/a29_25193643.jpg'
    , 'imagesphere/assets/bp/a30_25211055.jpg'
    , 'imagesphere/assets/bp/a31_25174055.jpg'
    , 'imagesphere/assets/bp/a32_25192283.jpg'
    , 'imagesphere/assets/bp/a33_25188737.jpg'
    , 'imagesphere/assets/bp/a34_25246989.jpg'
    , 'imagesphere/assets/bp/a35_06900880.jpg'
    //,"assets/chromeicon.webm"
    ];


  var tmpImages = [];
  var tmpHeadlines = [];

  // make a bunch of textures.
  // What to do if we run out of memory?
  for (var ii = 0; ii < g_imagesDownGrid; ++ii) {
    var textures = [];
    for (var jj = 0; jj < g_imagesAcrossGrid; ++jj) {
      var imgTexture = new ImgTexture();
      
      textures.push(imgTexture);
      if (tmpImages.length == 0) {
        tmpImages = images.slice();
      }
      if (tmpHeadlines.length == 0) {
        tmpHeadlines = headlines.slice();
      }
      var rando = math.randomInt(tmpImages.length);
      
      var img = tmpImages.splice(rando, 1)[0];
      var headline = tmpHeadlines.splice(rando, 1)[0];
      
      if (img.indexOf('videoplay.jpg') > -1){
        window.vidtexture = imgTexture;
        images = images.slice(1); // dont use that thumb again.
        headlines = 'WebGL Brings Video To the Party as Well'
      }
      
      imgTexture.load(img, /* "[" + jj + "/" + ii + "]" + */ headline);
    }
    g_textures.push(textures);
  }

  Log("--Setup ImagePlane---------------------------------------");
  var imagePlane = setupImagePlane();
  Log("--Setup BlankPlane---------------------------------------");
  var blankPlane = setupBlankPlane();

  var then = 0.0;
  var clock = 0.0;
  var fpsElem = document.getElementById("fps");

  var projection = new Float32Array(16);
  var view = new Float32Array(16);
  var world = new Float32Array(16);
  var worldInverse = new Float32Array(16);
  var worldInverseTranspose = new Float32Array(16);
  g_viewProjection = new Float32Array(16);
  var worldViewProjection = new Float32Array(16);
  var viewInverse = new Float32Array(16);
  g_viewProjectionInverse = new Float32Array(16);
  var eyePosition = new Float32Array(3);
  var target = new Float32Array(3);
  var up = new Float32Array([0,1,0]);
  var v3t0 = new Float32Array(3);
  var v3t1 = new Float32Array(3);
  var v3t2 = new Float32Array(3);
  var v3t3 = new Float32Array(3);
  var m4t0 = new Float32Array(16);
  var m4t1 = new Float32Array(16);
  var m4t2 = new Float32Array(16);
  var m4t3 = new Float32Array(16);
  var zero4 = new Float32Array(4);
  var one4 = new Float32Array([1,1,1,1]);
  var colorMult = new Float32Array(4);

  // Modern building uniforms.
  g.imagePlaneConst.viewProjection = g_viewProjection;
  var imagePlanePer = {
    world: world,
    colorMult: colorMult};

  var blankPlaneConst = {
    worldViewProjection: worldViewProjection};
  var blankPlanePer = { };

  var frameCount = 0;
  var intervalId = setInterval(render, 1000.0 / 70.0);
  
  
  var canvasClientWidth = canvas.clientWidth, 
      canvasClientHeight = canvas.clientHeight;
  
  // this gets run A LOT
  function render() {
    ++frameCount;
    if (g_drawOnce) {
      clearInterval(intervalId);
    }
    var now = (+new Date) * 0.001;
    var elapsedTime;
    if(then == 0.0) {
      elapsedTime = 0.0;
    } else {
      elapsedTime = now - then;
    }
    then = now;
    
   // reduce scope traversal  ! micro-ops!
    var gl = window.gl,
        fastmatrix4 = fast.matrix4,
        tdlmath = tdl.math,
        gglobals = g.globals;

    g_fpsTimer.update(elapsedTime);
    fpsElem.innerHTML = g_fpsTimer.averageFPS;

    clock += elapsedTime;
    eyePosition[0] = 0;
    eyePosition[1] = 0;
    eyePosition[2] = gglobals.eyeRadius;

    gl.colorMask(true, true, true, true);
    gl.depthMask(true);
    gl.clearDepth(1);
    gl.clearColor(0,0,0,1);
    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT | gl.STENCIL_BUFFER_BIT);

    gl.enable(gl.CULL_FACE);
    gl.enable(gl.DEPTH_TEST);

    fastmatrix4.perspective(
        projection,
        1.0471975511965976, //math.degToRad(60),
        canvasClientWidth / canvasClientHeight, // cached. gotta refresh if window changes size.
        1,
        5000);
    fastmatrix4.lookAt(
        view,
        eyePosition,
        target,
        up);
    fastmatrix4.mul(g_viewProjection, view, projection);
    fastmatrix4.inverse(viewInverse, view);
    fastmatrix4.inverse(g_viewProjectionInverse, g_viewProjection);

    // Draw a blank plane in the middle to mask out the back
    // of the sphere. Alternatively I could figure out why
    // the back of the sphere is not culled by CULL_FACE.
    
    //Log("--Draw Blank---------------------------------------");
    
    fastmatrix4.mul(
        world,
        fastmatrix4.scaling(m4t2, [100, 100, 100]),
        fastmatrix4.translation(m4t1, [0, 0, 1]));
    fastmatrix4.mul(worldViewProjection, world, g_viewProjection);
    blankPlane.drawPrep(blankPlaneConst);
    blankPlane.draw(blankPlanePer);

    //Log("--Draw Images---------------------------------------");
    // All we do is draw a grid of image. The shader warps the grid into a sphere.

    // dampen the velocity
    g_moveVelocityX *= 0.95;
    g_moveVelocityY *= 0.95;
    
    // space out on spin  -
    if (true && g_moveVelocityX != 0 && g_moveVelocityY != 0){
      var speed = Math.abs(g_moveVelocityY) + Math.abs(g_moveVelocityX);
      glProp('bendRadius',  2.4 + (speed / 50) * 0.3);
    }


    // scroll
    g_scrollX += g_moveVelocityX * elapsedTime;
    g_scrollY += g_moveVelocityY * elapsedTime;

    var si  = computeSphereGridInfo(),
        sel = computeSelection(si, g_lastMousePosition, g_lastMouseGridPosition);

    imagePlane.drawPrep(g.imagePlaneConst);
    
    
    
    var texturesPer = {},
        // more micro-ops.
        texRowIndex, textures, texColIndex, isSelected, mult;
        


    // SUPER LOOPS!
    for (var yy = 0; yy <= si.imagesDownSphere; ++yy) {
      texRowIndex = tdlmath.modClamp(si.texYBase + yy, g_imagesDownGrid);
      textures = g_textures[texRowIndex];
      for (var xx = -1; ++xx <= si.imagesAcrossSphere;  ) {   // OMG COOL GUY LOOP
        texColIndex = tdlmath.modClamp(si.texXBase + xx, g_imagesAcrossGrid);
        texturesPer.diffuseSampler = textures[texColIndex];
        fastmatrix4.mul(
            world,
            fastmatrix4.scaling(
                m4t0,
                [gglobals.imageWidth  * gglobals.imageScale,
                 gglobals.imageHeight * gglobals.imageScale,
                 1]),
            fastmatrix4.translation(
                m4t1,
                [(si.gridXOff + xx + si.xOff - (texRowIndex % 2) * gglobals.rowOffset) * si.unit.width,
                 (si.gridYOff + yy + si.yOff) * -si.unit.height,
                 0]));
        fastmatrix4.mul(worldViewProjection, world, g_viewProjection);
        
        isSelected = (sel.x == texColIndex && sel.y == texRowIndex);
        mult = isSelected ? 1 : 0.85;
        /* * /
        if (isSelected && glProp('bendAmount') == 1 && textures[sel.x].msg.indexOf('WebGL') == 0){ // window.aisdown
            console.log('supppp')
        }
        /* */
        colorMult[0] = mult;// + isSelected ? g.globals.selectionIntensity : 0);
        colorMult[1] = mult;
        colorMult[2] = mult;
        colorMult[3] = 1; // doesnt seem to do anything... 
        imagePlane.draw(imagePlanePer, texturesPer);
      }
    }

    // Set the alpha to 255.
    gl.colorMask(false, false, false, true);
    gl.clearColor(0,0,0,1);
    gl.clear(gl.COLOR_BUFFER_BIT);
//    gl.finish();

    // turn off logging after 1 frame.
    g_logGLCalls = false;
  } // eo render()
  
  
  
} // eo initialize()

var g_event;
var g_ui;


$(function(){
  
  
  kickOffUI();
  
  //disable webgl
  //return;

  initialize();
  

});
</script>
</head>
<body class="init">

<section id="welcome" class="prettybox">    
  <h1><span>WebGL</span> Story Sphere</h1>
  <p>
    Read the news in 360&deg;, hardware accelerated and in 3D space. Click thumbnails to expand into a full story.
  </p>
  <a class="button">Let's take a spin</a>
</section> 

   

<div id="uiContainer">

  <div id="ui">
    <div>
      <div>
        Size
      </div>
      <div id="imageScale" class="ui-slider ui-slider-horizontal ui-widget ui-widget-content ui-corner-all">
        <a href="#" class="ui-slider-handle ui-state-default ui-corner-all" style="left: 22.6%;"></a>
      </div>
    </div>

  <!-- disabling because stretching is bad  

    <div> <div> imageWidth </div>
      <div id="imageWidth" class="ui-slider ui-slider-horizontal ui-widget ui-widget-content ui-corner-all">
        <a href="#" class="ui-slider-handle ui-state-default ui-corner-all" style="left: 20%;"></a>
      </div>
    </div>
    <div> <div>  imageHeight  </div>
      <div id="imageHeight" class="ui-slider ui-slider-horizontal ui-widget ui-widget-content ui-corner-all">
        <a href="#" class="ui-slider-handle ui-state-default ui-corner-all" style="left: 20%;"></a>
      </div>
    </div> --> 
    <div>
      <div>
        Spacing
      </div>
      <div id="imageSpacing" class="ui-slider ui-slider-horizontal ui-widget ui-widget-content ui-corner-all">
        <a href="#" class="ui-slider-handle ui-state-default ui-corner-all" style="left: 20.6%;"></a>
      </div>
    </div>
    <div>
      <div>
        Row Offset
      </div>
      <div id="rowOffset" class="ui-slider ui-slider-horizontal ui-widget ui-widget-content ui-corner-all">
        <a href="#" class="ui-slider-handle ui-state-default ui-corner-all" style="left: 25%;"></a>
      </div>
    </div>
    <div>
      <div>
        Sphere Size
      </div>
      <div id="eyeRadius" class="ui-slider ui-slider-horizontal ui-widget ui-widget-content ui-corner-all">
        <a href="#" class="ui-slider-handle ui-state-default ui-corner-all" style="left: 50%;"></a>
      </div>
    </div>
   <!-- <div>
      <div>
        bendRadius
      </div>
      <div id="bendRadius" class="ui-slider ui-slider-horizontal ui-widget ui-widget-content ui-corner-all">
        <a href="#" class="ui-slider-handle ui-state-default ui-corner-all" style="left: 24%;"></a>
      </div>
    </div> -->
    <div>
      <div>
        Bend
      </div>
      <div id="bendAmount" class="ui-slider ui-slider-horizontal ui-widget ui-widget-content ui-corner-all">
        <a href="#" class="ui-slider-handle ui-state-default ui-corner-all" style="left: 0%;"></a>
      </div>
    </div>
  </div> <!-- eo #ui -->

  <div id="fpsContainer">
    <img src="imagesphere/assets/gears.svg">
    <div class="fps">fps: <span id="fps"></div>
    <!-- <div id="status"></div> -->
  </div>

</div> <!-- eo #uiContainer -->


<canvas id="canvas" width="1024" height="1024" style="width: 100%; height: 100%;"></canvas>


<div id="story" class="  prettybox" style="display:none"> <!-- vbox center aligncenter -->
 
  <img class="close" src="imagesphere/assets/close.png">
  <div id="storyinner">
    
     <!-- thumbnail and shit -->
<p>
    <strong class="strong byline">By JEFFREY KOFMAN</strong> 
                <br /> 

              10/11/10, 9:48 PM EDT
</p>
    <p>
    One for all and all for one, Muskehounds are always ready. One for all and all for one, helping everybody. One for all and all for one, it's a pretty story. Sharing everything with fun, that's the way to be. One for all and all for one, Muskehounds are always ready. One for all and all for one, helping everybody. One for all and all for one, can sound pretty corny. If you've got a problem chum, think how it could be.
    </p>

    <p>
    Barnaby The Bear's my name, never call me Jack or James, I will sing my way to fame, Barnaby the Bear's my name. Birds taught me to sing, when they took me to their king, first I had to fly, in the sky so high so high, so high so high so high, so - if you want to sing this way, think of what you'd like to say, add a tune and you will see, just how easy it can be. Treacle pudding, fish and chips, fizzy drinks and liquorice, flowers, rivers, sand and sea, snowflakes and the stars are free. La la la la la, la la la la la la la, la la la la la la la, la la la la la la la la la la la la la, so - Barnaby The Bear's my name, never call me Jack or James, I will sing my way to fame, Barnaby the Bear's my name.
    </p><p>
    There's a voice that keeps on calling me. Down the road, that's where I'll always be. Every stop I make, I make a new friend. Can't stay for long, just turn around and I'm gone again. Maybe tomorrow, I'll want to settle down, Until tomorrow, I'll just keep moving on.
    </p><p>
    Top Cat! The most effectual Top Cat! Who's intellectual close friends get to call him T.C., providing it's with dignity. Top Cat! The indisputable leader of the gang. He's the boss, he's a pip, he's the championship. He's the most tip top, Top Cat.
    </p><p>
    Hong Kong Phooey, number one super guy. Hong Kong Phooey, quicker than the human eye. He's got style, a groovy style, and a car that just won't stop. When the going gets tough, he's really rough, with a Hong Kong Phooey chop (Hi-Ya!). Hong Kong Phooey, number one super guy. Hong Kong Phooey, quicker than the human eye. Hong Kong Phooey, he's fan-riffic!</p>
  
  </div>
</div>


<video id="texture" autobuffer onplay="insertVideo(this);" onpause="insertVideo(false);"  src="http://studio.html5rocks.com/samples/video-player/chromeicon.webm" onended="this.play();"></video> 

<input/>

<script src="imagesphere/script.js"></script>



<!--- black shader -->
<script id="blackVertexShader" type="text/something-not-javascript">
uniform mat4 worldViewProjection;
attribute vec4 position;
void main() {
  gl_Position = worldViewProjection * position;
}
</script>
<script id="blackFragmentShader" type="text/something-not-javascript">
#ifdef GL_ES
precision highp float;
#endif
void main() {
  // background color of the gl
  // it's like rgb values / 255
  gl_FragColor = vec4(0.2,0.2,0.2,0);
}
</script>
<!--- imageSphere -->
<script id="imageSphereVertexShader" type="text/something-not-javascript">
uniform mat4 viewProjection;
uniform mat4 world;
uniform float bendRadius;
uniform float bendAmount;
attribute vec4 position;
attribute vec2 texCoord;
varying vec2 v_texCoord;
void main() {
  v_texCoord = texCoord;
  vec4 wp = world * position;
  float longitude = 3.14159 * 0.5 - wp.x;
  float latitude = 3.14159 * 0.5 - wp.y;
  float sinTheta = sin(longitude);
  float cosTheta = cos(longitude);
  float sinPhi = sin(latitude);
  float cosPhi = cos(latitude);
  float ux = cosTheta * sinPhi;
  float uy = cosPhi;
  float uz = sinTheta * sinPhi;
  vec4 wp1 = vec4(
    ux * bendRadius,
    uy * bendRadius,
    uz * bendRadius,
    1);
  vec4 wp2 = vec4(wp.x, wp.y, wp.z + bendRadius, 1.0);
  gl_Position = viewProjection * mix(wp2, wp1, bendAmount);
}

</script>
<script id="imageSphereFragmentShader" type="text/something-not-javascript">
#ifdef GL_ES
precision highp float;
#endif
varying vec2 v_texCoord;
uniform sampler2D diffuseSampler;
uniform vec4 colorMult;
void main() {
  vec4 diffuse = texture2D(diffuseSampler, vec2(v_texCoord.x, v_texCoord.y));
  gl_FragColor = diffuse * colorMult;
}
</script>

</body>


</html>


